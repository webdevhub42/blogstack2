{"expireTime":9007200911870455000,"key":"transformer-remark-markdown-html-0e5420366b898c8f4e3cec6e4e579362-gatsby-remark-prismjs-","val":"<h1>Fetch API</h1>\n<p>So far, we know quite a bit about <code class=\"language-text\">fetch</code>.</p>\n<p>Let's see the rest of API, to cover all its abilities.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Please note: most of these options are used rarely. You may skip this chapter and still use `fetch` well.\n\nStill, it's good to know what `fetch` can do, so if the need arises, you can return and read the details.</code></pre></div>\n<p>Here's the full list of all possible <code class=\"language-text\">fetch</code> options with their default values (alternatives in comments):</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">//</span>\n<span class=\"token keyword\">let</span> promise <span class=\"token operator\">=</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// POST, PUT, DELETE, etc.</span>\n  <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// the content type header value is usually auto-set</span>\n    <span class=\"token comment\">// depending on the request body</span>\n    <span class=\"token string-property property\">\"Content-Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"text/plain;charset=UTF-8\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span> <span class=\"token comment\">// string, FormData, Blob, BufferSource, or URLSearchParams</span>\n  <span class=\"token literal-property property\">referrer</span><span class=\"token operator\">:</span> <span class=\"token string\">\"about:client\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// or \"\" to send no Referer header,</span>\n  <span class=\"token comment\">// or an url from the current origin</span>\n  <span class=\"token literal-property property\">referrerPolicy</span><span class=\"token operator\">:</span> <span class=\"token string\">\"no-referrer-when-downgrade\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// no-referrer, origin, same-origin...</span>\n  <span class=\"token literal-property property\">mode</span><span class=\"token operator\">:</span> <span class=\"token string\">\"cors\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// same-origin, no-cors</span>\n  <span class=\"token literal-property property\">credentials</span><span class=\"token operator\">:</span> <span class=\"token string\">\"same-origin\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// omit, include</span>\n  <span class=\"token literal-property property\">cache</span><span class=\"token operator\">:</span> <span class=\"token string\">\"default\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// no-store, reload, no-cache, force-cache, or only-if-cached</span>\n  <span class=\"token literal-property property\">redirect</span><span class=\"token operator\">:</span> <span class=\"token string\">\"follow\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// manual, error</span>\n  <span class=\"token literal-property property\">integrity</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// a hash, like \"sha256-abcdef1234567890\"</span>\n  <span class=\"token literal-property property\">keepalive</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// true</span>\n  <span class=\"token literal-property property\">signal</span><span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// AbortController to abort request</span>\n  <span class=\"token literal-property property\">window</span><span class=\"token operator\">:</span> window <span class=\"token comment\">// null</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>An impressive list, right?</p>\n<p>We fully covered <code class=\"language-text\">method</code>, <code class=\"language-text\">headers</code> and <code class=\"language-text\">body</code> in the chapter &#x3C;info:fetch>.</p>\n<p>The <code class=\"language-text\">signal</code> option is covered in &#x3C;info:fetch-abort>.</p>\n<p>Now let's explore the remaining capabilities.</p>\n<h2>referrer, referrerPolicy</h2>\n<p>These options govern how <code class=\"language-text\">fetch</code> sets the HTTP <code class=\"language-text\">Referer</code> header.</p>\n<p>Usually that header is set automatically and contains the url of the page that made the request. In most scenarios, it's not important at all, sometimes, for security purposes, it makes sense to remove or shorten it.</p>\n<p><strong>The <code class=\"language-text\">referrer</code> option allows to set any <code class=\"language-text\">Referer</code> (within the current origin) or remove it.</strong></p>\n<p>To send no referer, set an empty string:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">//</span>\n<span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/page'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n<span class=\"token operator\">*</span><span class=\"token operator\">!</span><span class=\"token operator\">*</span>\n  <span class=\"token literal-property property\">referrer</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span> <span class=\"token comment\">// no Referer header</span>\n<span class=\"token operator\">*</span><span class=\"token operator\">/</span><span class=\"token operator\">!</span><span class=\"token operator\">*</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>To set another url within the current origin:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">//</span>\n<span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/page'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// assuming we're on https://javascript.info</span>\n  <span class=\"token comment\">// we can set any Referer header, but only within the current origin</span>\n<span class=\"token operator\">*</span><span class=\"token operator\">!</span><span class=\"token operator\">*</span>\n  <span class=\"token literal-property property\">referrer</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://javascript.info/anotherpage\"</span>\n<span class=\"token operator\">*</span><span class=\"token operator\">/</span><span class=\"token operator\">!</span><span class=\"token operator\">*</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>The <code class=\"language-text\">referrerPolicy</code> option sets general rules for <code class=\"language-text\">Referer</code>.</strong></p>\n<p>Requests are split into 3 types:</p>\n<ol>\n<li>Request to the same origin.</li>\n<li>Request to another origin.</li>\n<li>Request from HTTPS to HTTP (from safe to unsafe protocol).</li>\n</ol>\n<p>Unlike the <code class=\"language-text\">referrer</code> option that allows to set the exact <code class=\"language-text\">Referer</code> value, <code class=\"language-text\">referrerPolicy</code> tells the browser general rules for each request type.</p>\n<p>Possible values are described in the <a href=\"https://w3c.github.io/webappsec-referrer-policy/\">Referrer Policy specification</a>:</p>\n<ul>\n<li><strong><code class=\"language-text\">\"no-referrer-when-downgrade\"</code></strong> -- the default value: full <code class=\"language-text\">Referer</code> is always sent, unless we send a request from HTTPS to HTTP (to the less secure protocol).</li>\n<li><strong><code class=\"language-text\">\"no-referrer\"</code></strong> -- never send <code class=\"language-text\">Referer</code>.</li>\n<li><strong><code class=\"language-text\">\"origin\"</code></strong> -- only send the origin in <code class=\"language-text\">Referer</code>, not the full page URL, e.g. only <code class=\"language-text\">http://site.com</code> instead of <code class=\"language-text\">http://site.com/path</code>.</li>\n<li><strong><code class=\"language-text\">\"origin-when-cross-origin\"</code></strong> -- send the full <code class=\"language-text\">Referer</code> to the same origin, but only the origin part for cross-origin requests (as above).</li>\n<li><strong><code class=\"language-text\">\"same-origin\"</code></strong> -- send the full <code class=\"language-text\">Referer</code> to the same origin, but no <code class=\"language-text\">Referer</code> for cross-origin requests.</li>\n<li><strong><code class=\"language-text\">\"strict-origin\"</code></strong> -- send only the origin, not the <code class=\"language-text\">Referer</code> for HTTPS→HTTP requests.</li>\n<li><strong><code class=\"language-text\">\"strict-origin-when-cross-origin\"</code></strong> -- for same-origin send the full <code class=\"language-text\">Referer</code>, for cross-origin send only the origin, unless it's HTTPS→HTTP request, then send nothing.</li>\n<li><strong><code class=\"language-text\">\"unsafe-url\"</code></strong> -- always send the full url in <code class=\"language-text\">Referer</code>, even for HTTPS→HTTP requests.</li>\n</ul>\n<p>Here's a table with all combinations:</p>\n<table>\n<thead>\n<tr>\n<th>Value</th>\n<th>To same origin</th>\n<th>To another origin</th>\n<th>HTTPS→HTTP</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">\"no-referrer\"</code></td>\n<td>-</td>\n<td>-</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">\"no-referrer-when-downgrade\"</code> or <code class=\"language-text\">\"\"</code> (default)</td>\n<td>full</td>\n<td>full</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">\"origin\"</code></td>\n<td>origin</td>\n<td>origin</td>\n<td>origin</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">\"origin-when-cross-origin\"</code></td>\n<td>full</td>\n<td>origin</td>\n<td>origin</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">\"same-origin\"</code></td>\n<td>full</td>\n<td>-</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">\"strict-origin\"</code></td>\n<td>origin</td>\n<td>origin</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">\"strict-origin-when-cross-origin\"</code></td>\n<td>full</td>\n<td>origin</td>\n<td>-</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">\"unsafe-url\"</code></td>\n<td>full</td>\n<td>full</td>\n<td>full</td>\n</tr>\n</tbody>\n</table>\n<p>Let's say we have an admin zone with a URL structure that shouldn't be known from outside of the site.</p>\n<p>If we send a <code class=\"language-text\">fetch</code>, then by default it always sends the <code class=\"language-text\">Referer</code> header with the full url of our page (except when we request from HTTPS to HTTP, then no <code class=\"language-text\">Referer</code>).</p>\n<p>E.g. <code class=\"language-text\">Referer: https://javascript.info/admin/secret/paths</code>.</p>\n<p>If we'd like other websites know only the origin part, not the URL-path, we can set the option:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">//</span>\n<span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://another.com/page'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token literal-property property\">referrerPolicy</span><span class=\"token operator\">:</span> <span class=\"token string\">'origin-when-cross-origin'</span> <span class=\"token comment\">// Referer: https://javascript.info</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We can put it to all <code class=\"language-text\">fetch</code> calls, maybe integrate into JavaScript library of our project that does all requests and uses <code class=\"language-text\">fetch</code> inside.</p>\n<p>Its only difference compared to the default behavior is that for requests to another origin <code class=\"language-text\">fetch</code> sends only the origin part of the URL (e.g. <code class=\"language-text\">https://javascript.info</code>, without path). For requests to our origin we still get the full <code class=\"language-text\">Referer</code> (maybe useful for debugging purposes).</p>\n<p>`<code class=\"language-text\"></code>text header=\"Referrer policy is not only for <code class=\"language-text\">fetch</code>\" Referrer policy, described in the <a href=\"https://w3c.github.io/webappsec-referrer-policy/\">specification</a>, is not just for <code class=\"language-text\">fetch</code>, but more global.</p>\n<p>In particular, it's possible to set the default policy for the whole page using the <code class=\"language-text\">Referrer-Policy</code> HTTP header, or per-link, with <code class=\"language-text\">&lt;a rel=\"noreferrer\"></code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">## mode\n\nThe `mode` option is a safe-guard that prevents occasional cross-origin requests:\n\n- **`\"cors\"`** -- the default, cross-origin requests are allowed, as described in &lt;info:fetch-crossorigin>,\n- **`\"same-origin\"`** -- cross-origin requests are forbidden,\n- **`\"no-cors\"`** -- only safe cross-origin requests are allowed.\n\nThis option may be useful when the URL for `fetch` comes from a 3rd-party, and we want a \"power off switch\" to limit cross-origin capabilities.\n\n## credentials\n\nThe `credentials` option specifies whether `fetch` should send cookies and HTTP-Authorization headers with the request.\n\n- **`\"same-origin\"`** -- the default, don't send for cross-origin requests,\n- **`\"include\"`** -- always send, requires `Accept-Control-Allow-Credentials` from cross-origin server in order for JavaScript to access the response, that was covered in the chapter &lt;info:fetch-crossorigin>,\n- **`\"omit\"`** -- never send, even for same-origin requests.\n\n## cache\n\nBy default, `fetch` requests make use of standard HTTP-caching. That is, it respects the `Expires` and `Cache-Control` headers, sends `If-Modified-Since` and so on. Just like regular HTTP-requests do.\n\nThe `cache` options allows to ignore HTTP-cache or fine-tune its usage:\n\n- **`\"default\"`** -- `fetch` uses standard HTTP-cache rules and headers,\n- **`\"no-store\"`** -- totally ignore HTTP-cache, this mode becomes the default if we set a header `If-Modified-Since`, `If-None-Match`, `If-Unmodified-Since`, `If-Match`, or `If-Range`,\n- **`\"reload\"`** -- don't take the result from HTTP-cache (if any), but populate the cache with the response (if the response headers permit this action),\n- **`\"no-cache\"`** -- create a conditional request if there is a cached response, and a normal request otherwise. Populate HTTP-cache with the response,\n- **`\"force-cache\"`** -- use a response from HTTP-cache, even if it's stale. If there's no response in HTTP-cache, make a regular HTTP-request, behave normally,\n- **`\"only-if-cached\"`** -- use a response from HTTP-cache, even if it's stale. If there's no response in HTTP-cache, then error. Only works when `mode` is `\"same-origin\"`.\n\n## redirect\n\nNormally, `fetch` transparently follows HTTP-redirects, like 301, 302 etc.\n\nThe `redirect` option allows to change that:\n\n- **`\"follow\"`** -- the default, follow HTTP-redirects,\n- **`\"error\"`** -- error in case of HTTP-redirect,\n- **`\"manual\"`** -- allows to process HTTP-redirects manually. In case of redirect, we'll get a special response object, with `response.type=\"opaqueredirect\"` and zeroed/empty status and most other properies.\n\n## integrity\n\nThe `integrity` option allows to check if the response matches the known-ahead checksum.\n\nAs described in the [specification](https://w3c.github.io/webappsec-subresource-integrity/), supported hash-functions are SHA-256, SHA-384, and SHA-512, there might be others depending on the browser.\n\nFor example, we're downloading a file, and we know that it's SHA-256 checksum is \"abcdef\" (a real checksum is longer, of course).\n\nWe can put it in the `integrity` option, like this:\n\n```js\n//\nfetch('http://site.com/file', {\n  integrity: 'sha256-abcdef'\n});</code></pre></div>\n<p>Then <code class=\"language-text\">fetch</code> will calculate SHA-256 on its own and compare it with our string. In case of a mismatch, an error is triggered.</p>\n<h2>keepalive</h2>\n<p>The <code class=\"language-text\">keepalive</code> option indicates that the request may \"outlive\" the webpage that initiated it.</p>\n<p>For example, we gather statistics on how the current visitor uses our page (mouse clicks, page fragments he views), to analyze and improve the user experience.</p>\n<p>When the visitor leaves our page -- we'd like to save the data to our server.</p>\n<p>We can use the <code class=\"language-text\">window.onunload</code> event for that:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// run</span>\nwindow<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onunload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/analytics'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token string\">\"statistics\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token operator\">*</span><span class=\"token operator\">!</span><span class=\"token operator\">*</span>\n    <span class=\"token literal-property property\">keepalive</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n<span class=\"token operator\">*</span><span class=\"token operator\">/</span><span class=\"token operator\">!</span><span class=\"token operator\">*</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Normally, when a document is unloaded, all associated network requests are aborted. But the <code class=\"language-text\">keepalive</code> option tells the browser to perform the request in the background, even after it leaves the page. So this option is essential for our request to succeed.</p>\n<p>It has a few limitations:</p>\n<ul>\n<li>\n<p>We can't send megabytes: the body limit for <code class=\"language-text\">keepalive</code> requests is 64KB.</p>\n<ul>\n<li>If we need to gather a lot of statistics about the visit, we should send it out regularly in packets, so that there won't be a lot left for the last <code class=\"language-text\">onunload</code> request.</li>\n<li>This limit applies to all <code class=\"language-text\">keepalive</code> requests together. In other words, we can perform multiple <code class=\"language-text\">keepalive</code> requests in parallel, but the sum of their body lengths should not exceed 64KB.</li>\n</ul>\n</li>\n<li>\n<p>We can't handle the server response if the document is unloaded. So in our example <code class=\"language-text\">fetch</code> will succeed due to <code class=\"language-text\">keepalive</code>, but subsequent functions won't work.</p>\n<ul>\n<li>In most cases, such as sending out statistics, it's not a problem, as the server just accepts the data and usually sends an empty response to such requests.</li>\n</ul>\n</li>\n</ul>"}